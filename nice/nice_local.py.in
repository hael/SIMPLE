#!@SIMPLE_PATH@/nice/venv/bin/python3
import os
import time
import webbrowser
from subprocess import run, Popen
from dirsync    import sync

if __name__ == "__main__":
    user_home = os.path.expanduser('~')
    user_nice = os.path.join(user_home, ".nice", "nice_4_0")
    src_nice  = "@SIMPLE_PATH@/nice"
    if not os.path.exists(user_nice):
        os.makedirs(user_nice)
        print("created", user_nice)
    print("syncing", src_nice, "->", user_nice)
    sync(src_nice, user_nice, 'sync', exclude=('^.git', '^build', '^db.sqlite3', '.*__pycache__.*', 'Makefile', 'CMake.*', '.*.cmake'))
    os.rename(os.path.join(user_nice, "nice_project", "settings_local.py"), os.path.join(user_nice, "nice_project", "settings.py"))
    print("updating database")
    run(["@SIMPLE_PATH@/nice/venv/bin/python3", "manage.py", "makemigrations"],          cwd=user_nice)
    run(["@SIMPLE_PATH@/nice/venv/bin/python3", "manage.py", "migrate"],                 cwd=user_nice)
    run(["@SIMPLE_PATH@/nice/venv/bin/python3", "manage.py", "ensurelocaluser"],         cwd=user_nice)
    run(["@SIMPLE_PATH@/nice/venv/bin/python3", "manage.py", "resetsubmissiontemplate", "@SIMPLE_PATH@"], cwd=user_nice)
    print("starting server")
    print("\tusername : ", os.getlogin())
    print("\tpassword : ", "simple")
    server = Popen(["@SIMPLE_PATH@/nice/venv/bin/python3", "manage.py", "runserver"], cwd=user_nice)
    print("opening URL", "http://localhost:8000")
    time.sleep(2)
    webbrowser.open_new("http://localhost:8000")
    server.communicate() # block until server is killed (ctrl-C)
