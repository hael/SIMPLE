#!/bin/bash
## SIMPLE_TESTBENCH
if [ -z "${SIMPLE_TESTBENCH_DATA+set}" ]; then
   echo "SIMPLE_TESTBENCH_DATA env variable is not set."; exit 1
fi

if [ ! -d "${SIMPLE_TESTBENCH_DATA}" ]; then
    echo "SIMPLE_TESTBENCH_DATA variable is not a directory."; exit 1
fi

if [ ! -d "${SIMPLE_TESTBENCH_DATA}/recvol_1wcm" ]; then
    echo "recvol_1wcm is not a directory in the benchmark data folder."; exit 1
fi
cd ${SIMPLE_TESTBENCH_DATA}/recvol_1wcm

echo " ## Expected Output: 10 core, Intel Xeon E5-2650, Compiled with GNU_RELEASE_FFTW  "
echo " ## >>> DONE PROCESSING PARAMETERS                                                "
echo " ## >>> DONE BUILDING GENERAL TOOLBOX                                             "
echo " ## >>> DONE BUILDING RECONSTRUCTION TOOLBOX                                      "
echo " ## >>> KAISER-BESSEL INTERPOLATION                                               "
echo " ## Percent Complete:  100%                                                       "
echo " ## >>> SAMPLING DENSITY (RHO) CORRECTION & WIENER NORMALIZATION                  "
echo " ## GENERATED VOLUMES: recvol*.ext                                                "
echo " ## **** SIMPLE_RECVOL NORMAL STOP ****                                           "
echo " ##                                                                               "
echo " ## real 0m3.263s                                                                 "
echo " ## user 0m47.543s                                                                "
echo " ## sys 0m0.345s                                                                  "
echo "                                                                                  "

#time simple_distr_exec prg=reconstruct3D ctf=no msk=50 oritab=projvol_oris.txt pgrp=c1 smpd=2 stk=projs.mrc
[ -d reconstruct3D_test ] && rm -rf reconstruct3D_test
simple_exec prg=new_project projname=reconstruct3D_test
if [ ! -d reconstruct3D_test ]; then
    echo "new_project could not create folder"
else
    cd reconstruct3D_test
    nice simple_exec prg=import_particles ctf=no oritab=../projvol_oris.txt pgrp=c1 smpd=2 stk=../projs.mrc projname=reconstruct3D_test
# cs=2.7 kv=300 fraca=0.1 deftab=../extract_params.txt stk=../sumstack.mrc smpd=1.275 projfile=recvol.simple
    time simple_distr_exec prg=reconstruct3D msk=50 nthr=10

    echo " ## >>> TESTING AGAINST REFERENCE IMAGE                                           "
    #[ -f recvol_diff.mrc ] &&  rm -f recvol_diff.mrc
    #simple_exec prg=image_diff stk=recvol_state01.mrc stk2=reference/recvol_state01.mrc outstk=recvol_diff.mrc
    if [ -x chimera ]; then
        chimera recvol_state01.mrc ../reference/recvol_state01.mrc
    fi
fi
