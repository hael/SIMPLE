<DOCTYPE html>
<html>
 <head>
  <style>
	body {
		font-family: Verdana, Geneva, sans-serif;
		margin: 0px;
		overflow: hidden;
		}
		
	.mainpane {
		overflow: auto;
		height: calc(100vh - 50px);
	}
		
	.header {
		height: 40px;
		padding: 5px;
		padding-left: 30px;
		}
		
	.headermenu,.headertitle{
		display: inline-block;
		}
			
	
	.headermenuelements {
		width: 185px;
		text-align: left;
		padding: 5px;
		display: none;
		position: absolute;
		background-color: #d7d7d7;
		font-size: 12px;
		left: 40px;
		top: 20px;
		z-index: 101;
		}

	.headermenu div:hover{
		background-color: #acb2ba;
		}
		
	.simpleicon{
		height: 20px;
		}
		
	.closeicon{
		height: 16px;
		float: right;
		}	
	
	.popup{
		position: absolute;
		background-color: white;
		}
		
	.thumbnail{
		display: inline-block;
		margin: 5px;
		}
			
	.thumbnailimage{
		margin: 2px;
		width:	100px;
		height:	100px;
		}	
		
	 #viewcontrols {
		border-style: solid;
		border-width: 1px;
		width: 300px;
		height: 300px;
		top: calc(50vh - 150px);
		left: calc(50vw - 150px);
	 }
		
	
		
</style>
 </head>
 <body>
	 
  <div class=header>
	<div class=headermenu id=headermenu onclick=''>
		<img class=simpleicon src=img/simple_favicon.ico onclick="showHeaderMenu()" >
		<div class=headermenuelements id=headermenuelements></div>
	</div>  
	<div class=headertitle>
		<div class=subtitle id=bodysubtitle></div>
		<div class=title id=bodytitle></div>
	</div>
	<img src=img/close.png class=closeicon onclick=''>
  </div>
  
  <div class=mainpane id=mainpane></div>
	
  <div class=gauze id=gauze></div>
 
  <script>
	
  var sourcefiles;
  var targetflags;
  var rootdir;
  var loadqueue;
	  
  function getAjax (url, success) {
		var xhr = new XMLHttpRequest();
		xhr.open('GET', url, true);
		xhr.onreadystatechange = function() {
			if (xhr.readyState>3 && xhr.status==200){
				success(xhr.responseText);
			}
		};
		xhr.send();
	}
	  
  function showHeaderMenu(){
	  document.getElementById('headermenuelements').style.display = "block";
  }
  
  function hideHeaderMenu(){
	  document.getElementById('headermenuelements').style.display = "none";
  }
  
  function clearHeaderMenu(){
	  document.getElementById('headermenuelements').innerHTML = "";
  }
  
  function addHeaderMenuElement(elementName, elementFunction){
	  var div = document.createElement("div");
	  div.className = "headermenuelement";
	  div.innerHTML = elementName;
	  div.onclick = elementFunction;
	  document.getElementById('headermenuelements').appendChild(div);
  }
  
  function createPopup() {
	  var popup = document.createElement("div");
	  var header = document.createElement("div");
	  var headertitle = document.createElement("div");
	  var popuptitle = document.createElement("div");
	  var simpleicon = document.createElement("img");
	  var closeicon = document.createElement("img");
	  popup.className = "popup";
	  header.className = "header popupheader";
	  headertitle.className = "headertitle";
	  popuptitle.className = "title";
	  simpleicon.className = "simpleicon";
	  closeicon.className = "closeicon";
	  simpleicon.src = 'img/simple_favicon.ico';
	  closeicon.src = 'img/close.png';
	  closeicon.onclick = function(){popup.remove()};
	  headertitle.appendChild(popuptitle);
	  header.appendChild(simpleicon);
	  header.appendChild(headertitle);
	  header.appendChild(closeicon);
	  popup.appendChild(header);
	  return popup;
  }
  
  function createInput(type, label, id, minimum, maximum, step){
	  var div = document.createElement("div");
	  var input = document.createElement("input");
	  var helpicon = document.createElement("img");
	  input.id = id;
	  input.type = type;
	  input.min = minimum;
	  input.max = maximum;
	  div.innerHTML = label;
	  div.appendChild(input);
	  div.appendChild(helpicon);
	 return div;
  }
  
  function createSelect(label, id){
	  var div = document.createElement("div");
	  var select = document.createElement("select");
	  var helpicon = document.createElement("img");
	  select.id = id;
	  div.innerHTML = label;
	  div.appendChild(select);
	  div.appendChild(helpicon);
	 return div;
  }
  
  function createOption(label, value){
	  var option = document.createElement("option");
	  option.innerHTML = label;
	  option.value = value
	 return option;
  }
  
  function createButton(label, elementFunction){
	  var button = document.createElement("button");
	  button.innerHTML = label;
	  button.onclick = elementFunction;
	 return button;
  }
  
  function createThumbnails(thumbnails){
	  var div = document.createElement("div");
	  for(var i = 0; i < thumbnails.length ; i++){
		var thumbnail = document.createElement("div");
		thumbnail.className = "thumbnail";
		for(var j = 0; j < thumbnails[i].length; j++){
			var imagediv = document.createElement("div");
			var image = document.createElement("img");
			image.className = "thumbnailimage";
			image.alt = "Loading ...";
			var keys = Object.keys(thumbnails[i][j]);
			for(var k = 0; k < keys.length; k++){
				image.setAttribute("data-" + keys[k], thumbnails[i][j][keys[k]]);
			}
			imagediv.appendChild(image);
			thumbnail.appendChild(imagediv);
		}
		div.appendChild(thumbnail);
	  }
	 return div;
  }
  
  function dragPopup(popup, elmnt) {
	  
	var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
	
    elmnt.onmousedown = dragMouseDown;

	function dragMouseDown(e) {
		e = e || window.event;
		pos3 = e.clientX;
		pos4 = e.clientY;
		document.onmouseup = closeDragElement;
		document.onmousemove = elementDrag;
	}

	function elementDrag(e) {
		e = e || window.event;
		pos1 = pos3 - e.clientX;
		pos2 = pos4 - e.clientY;
		pos3 = e.clientX;
		pos4 = e.clientY;
		popup.style.top = (popup.offsetTop - pos2) + "px";
		popup.style.left = (popup.offsetLeft - pos1) + "px";
	  }

    function closeDragElement() {
		document.onmouseup = null;
		document.onmousemove = null;
	}
}
  
  function showViewControls(){
	 hideHeaderMenu();
	 var popup = createPopup();
	 popup.id = "viewcontrols";
	 popup.getElementsByClassName('title')[0].innerHTML = "View Controls";
	 if(targetflags.length > 0){
		var select = createSelect("Target", "viewcontrolstarget");
		for(var i = 0; i < targetflags.length; i++){
			select.getElementsByTagName('select')[0].appendChild(createOption(targetflags[i].id, i)); 
		}
		popup.appendChild(select); 
		select.onchange = function(){setViewControls()};
	 }

	 popup.appendChild(createInput("range", "Contrast", "viewcontrolscontrast", 0.5, 10, 0.5));
	 popup.appendChild(createInput("range", "Brightness", "viewcontrolsbrightness", 0.5, 256, 0.5));
	 popup.appendChild(createInput("range", "Scale", "viewcontrolsscale",0.1, 10, 0.1));
	 popup.appendChild(createInput("range", "Zoom", "viewcontrolszoom", 0.1, 10, 0.1));
	 popup.appendChild(createButton("Apply", updateViewControls));
	 dragPopup(popup, popup.getElementsByClassName('title')[0]);
	 document.body.appendChild(popup); 
	 setViewControls();
  }
  
  function setViewControls(){
	 var viewcontrolstarget = document.getElementById('viewcontrolstarget');
	 var targetflagid = viewcontrolstarget.options[viewcontrolstarget.selectedIndex].value;
	 document.getElementById('viewcontrolscontrast').value = targetflags[targetflagid]['contrast'];
	 document.getElementById('viewcontrolsbrightness').value = targetflags[targetflagid]['brightness'];
	 document.getElementById('viewcontrolsscale').value = targetflags[targetflagid]['scale'];
	 document.getElementById('viewcontrolszoom').value = targetflags[targetflagid]['zoom'];
  }
   
  function updateViewControls(){
	 var viewcontrolstarget = document.getElementById('viewcontrolstarget');
	 var targetflagid = viewcontrolstarget.options[viewcontrolstarget.selectedIndex].value;
	 targetflags[targetflagid]['contrast'] = document.getElementById('viewcontrolscontrast').value;
	 targetflags[targetflagid]['brightness'] = document.getElementById('viewcontrolsbrightness').value;
	 targetflags[targetflagid]['scale'] = document.getElementById('viewcontrolsscale').value;
	 targetflags[targetflagid]['zoom'] = document.getElementById('viewcontrolszoom').value;
	 setThumbnailSources();
  }
  
  function createLoadQueue() {
	 loadqueue = [];
	 var images = document.getElementsByClassName('thumbnailimage');
	 var mainpane = document.getElementById('mainpane');
	 var paneBoundingClientRect = mainpane.getBoundingClientRect(); 
	 var topcutoff = paneBoundingClientRect.top;
	 var bottomcutoff = paneBoundingClientRect.bottom + (paneBoundingClientRect.bottom - paneBoundingClientRect.top);
	 for (var i = 0; i < images.length; i++){
		 var snapshotBoundingClientRect = images[i].getBoundingClientRect();
		 if(snapshotBoundingClientRect.bottom > topcutoff && snapshotBoundingClientRect.top < bottomcutoff) {
			 loadqueue.push(images[i]);
		 } else {
			 images[i].removeAttribute('src');
		 }
	 }
	 loadImages();
  }
  
  function loadImages(){
	if(loadqueue.length > 0){
		loadqueue[0].src = loadqueue[0].getAttribute('data-src');
		loadqueue[0].onload = loadqueue[0].onerror = function() { loadImages(); }
		loadqueue.shift();
	}
  }
  
  function setThumbnailSources() {
	  var images = document.getElementsByClassName('thumbnailimage');
	  for(var i = 0; i < images.length; i++){
		  var sourcefile = sourcefiles[images[i].getAttribute('data-sourcefile')];
		  var image = images[i].getAttribute('data-image');
		  var contrast = targetflags[images[i].getAttribute('data-targetflag')]["contrast"];
		  var brightness = targetflags[images[i].getAttribute('data-targetflag')]["brightness"];
		  var scale = targetflags[images[i].getAttribute('data-targetflag')]["scale"];
		  var zoom = targetflags[images[i].getAttribute('data-targetflag')]["zoom"];
		  images[i].style.width = 100 * scale + "px";
		  images[i].style.height = 100 * scale + "px";
		  images[i].setAttribute('data-src', "JPEGhandler?filename="+ rootdir + "/" + sourcefile + "&contrast=" + contrast + "&brightness=" + brightness + "&frameid=" + image);
	  }
	  createLoadQueue();
  }
  
  function ini3dViewInit(data){
	var JSONdata = JSON.parse(data);
	sourcefiles = JSONdata.sourcefiles;
	targetflags = JSONdata.targetflags;
	rootdir = JSONdata.rootdir;
	document.getElementById('mainpane').innerHTML = "";
	document.getElementById('bodytitle').innerHTML = "Ini3D View";
	clearHeaderMenu();
	addHeaderMenuElement("View Controls", showViewControls);
	document.getElementById('mainpane').appendChild(createThumbnails(JSONdata.thumbnails));
	setThumbnailSources();
	document.getElementById('mainpane').addEventListener('scroll', function(){createLoadQueue()});
  }
  
  getAjax("JSONhandler?function=ini3dview&folder=/tmp/19_ini3D", ini3dViewInit);
  
  </script>
  
  
 </body>
</html> 
