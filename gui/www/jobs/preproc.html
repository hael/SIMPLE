<DOCTYPE html>
<html>
 <head>
  <link rel="stylesheet" href="../css/job.css">
 </head>
 <body>
	 
  <div class=header>
   Preprocessing
  </div>
  
  <div class=jobinfo>
	<p>Perform Movie squashing, CTF parameter estimation, automatic particle picking and extraction</p>
  </div>
  
	<div class=jobpane>
		<form id=jobform action='../JSONhandler' onsubmit="parent.parent.parent.document.getElementById('mainpaneiframe').src = 'projecthistory.html'">
			<input type=hidden name=function value=simplejob>
			<input type=hidden name=program value=preproc>
			<input type=hidden name=jobstatus value=starting>
			<input type=hidden name=jobtype value=preproc>
			<input type=hidden name=jobpid value=0>
			<input type=hidden id=projecttable name=table value=0>
			<input type=hidden id=projectfolder name=jobfolder value=0>
			
			<table id=page1>
				<tr>
					<td colspan=2><b>Job Parameters</b></td>
				</tr>
				<tr>
					<td>Job Name</td>
					<td><input data-required=no type=text name=jobname placeholder="job identifier"></td>
				</tr>
				<tr data-required=no>
					<td>Job Description</td>
					<td><textarea data-required=no name=jobdescription placeholder="free text description of job"></textarea></td>
				</tr>
				<tr>
					<td colspan=2 style="text-align: center">
						<button type="button" onclick="document.getElementById('page1').style.display = 'none'; document.getElementById('page2').style.display = 'block'">Next</button>
					</td>
				</tr>
			</table>
			
			<table id=page2 style="display:none">
				<tr>
					<td colspan=2><b>Required Parameters</b></td>
				</tr>
				<tr>
					<td>Movies Directory</td>
					<td><input data-required=no type=text name=dir_movies id=dir_movies placeholder="folder containing movies"></td>
					<td><img src=../img/folder.png onclick="folderSelect(this)" data-target=dir_movies></td>
				</tr>
				<tr>
					<td>Sampling Distance</td>
					<td><input data-required=no type=number step=0.001 name=smpd placeholder="pixel size in Angstroms" title="Size of detector pixels in Angstroms at magnification of data collection"></td>
					<td></td>
					<td>Spherical Aberration</td>
					<td><input data-required=no type=number name=cs placeholder="microscope cs in mm {2.7}" title="Microscope spherical aberration constrant in mm {2.7}"></td>
				</tr>
					<td>Amplitude Contrast</td>
					<td><input data-required=no type=number name=fraca placeholder="amplitude contrast {0.07}" title="Amplitude contrast {0.07}"></td>
					<td></td>
					<td>Acceleration Voltage</td>
					<td><input data-required=no type=number name=kv placeholder="microscope acceleration voltage in kV" title="Microscope acceleration voltage in kV"></td>
				<tr>
					<td colspan=5 style="text-align: center">
						<button type="button" onclick="document.getElementById('page2').style.display = 'none'; document.getElementById('page1').style.display = 'block'">Back</button>
						<button type="button" onclick="document.getElementById('page2').style.display = 'none'; document.getElementById('page3').style.display = 'block'">Next</button>
					</td>
				</tr>
			</table>
			
			<table id=page3 style="display:none">
				<tr>
					<td colspan=2><b>Optional Parameters For Motion Correction</b></td>
				</tr>
				<tr>
					<td>Dose Rate</td>
					<td><input data-required=no type=number name=dose_rate placeholder="Dose rate in e-/A^2/s" title="Dose rate in e-/A^2/s"></td>
					<td></td>
					<td>Exposure Time</td>
					<td><input data-required=no type=number name=exp_time placeholder="exposure length in seconds" title="Exposure length in seconds"></td>
				</tr>
				<tr>
					<td>From Frame</td>
					<td><input data-required=no type=number name=fromf placeholder="first frame to include in partial dose micrograph" title="First movie frame to include in additional partial dose micrograph"></td>
					<td></td>
					<td>To Frame</td>
					<td><input data-required=no type=number name=tof placeholder="last frame to include in partial dose micrograph" frame to include in partial dose micrograph" title="Last movie frame to include in additional partial dose micrograph"></td>
				</tr>
				<tr>
					<td>Initial High Resolution Limit</td>
					<td><input data-required=no type=number name=lpstart placeholder="Initial high resolution limit in Angstroms {15A}" title="Starting high resolution for motion correction in A {15A}"></td>
					<td></td>
					<td>Final High Resolution Limit</td>
					<td><input data-required=no type=number name=lpstop placeholder="Final high resolution limit in Angstroms {15A}" title="Final high resolution for motion correction in A {8}"></td>
				</tr>
				<tr>
					<td>Unblur Power Spectrum Size</td>
					<td><input data-required=no type=number name=pspecz_unblur placeholder="size of power spectrum written in pixels {512}" title="Size of power spectrum written in pixels {512}"></td>
					<td></td>
					<td>Phaseplate</td>
					<td>
						<select data-required=no name=phaseplate>
							<option value=yes>Yes</option>
							<option value=no selected>No</option>
						</select>
					</td>
				</tr>
				<tr>
					<td>Image Scale Factor</td>
					<td><input data-required=no type=number name=scale placeholder="scaling factor for output micrographs {1}" title="Scaling Factor for output micrographs e.g. for downsampling super-resolution movies {1}"></td>
					<td></td>
					<td>Frames to Group Before Unblur</td>
					<td><input data-required=no type=number name=nframesgrp placeholder="# frames to group before unblur" title="Number of frames in original movie to group before motion correction for very low dose frames {0}"></td>
				</tr>
				
				<tr>
					<td colspan=5 style="text-align: center">
						<button type="button" onclick="document.getElementById('page3').style.display = 'none'; document.getElementById('page2').style.display = 'block'">Back</button>
						<button type="button" onclick="document.getElementById('page3').style.display = 'none'; document.getElementById('page4').style.display = 'block'">Next</button>
					</td>
				</tr>
			</table>
			
			<table id=page4 style="display:none">
				<tr>
					<td colspan=2><b>Optional Parameters For CTF Estimation</b></td>
				</tr>
				<tr>
					<td>Expected Astigmatism </td>
					<td><input data-required=no type=number name=astigtol placeholder="expected astigmatism in microns {0.05}" title="Level of astimagtism tolerated in fitting in microns {0.05}"></td>
					<td></td>
					<td>Maximum Expected Defocus </td>
					<td><input data-required=no type=number name=dfmax placeholder="expected maximum defocus in microns {5.0}" title="Maximum (further from focus) expected defocus in microns {5.0}"></td>
				</tr>
				<tr>
					<td>Minimum Expected Defocus</td>
					<td><input data-required=no type=number name=dfmin placeholder="expected minium defocus in microns {0.5}" title="Minimum (closest to focus) expected defocus in microns {0.5}"></td>
					<td></td>
					<td>Defocus Search Step</td>
					<td><input data-required=no type=number name=dfstep placeholder="defocus search step size in microns {0.05}" title="Defocus search step size in microns {0.05}"></td>
				</tr>
				<tr>
					<td>CTFFIND Low Resolution Limit</td>
					<td><input data-required=no type=number name=hp_ctffind placeholder="low resolution limit for fitting in Angstroms" title="Lowest resolution frequencies used in fitting in Angstroms {?}"></td>
					<td></td>
					<td>CTFFIND High Resolution Limit</td>
					<td><input data-required=no type=number name=lp_ctffind placeholder="high resolution limit for fitting in Angstroms" title="Highest resolution frequencies used in fitting in Angstroms {?}"></td>
				</tr>
				<tr>
					<td>CTFFIND Power Spectrum Size</td>
					<td><input data-required=no type=number name=pspecz_ctffind placeholder="size of powerspectrum written in pixels {512}" title="Size of powerspectrum written in pixels {512}"></td>
				</tr>
				
				<tr>
					<td colspan=5 style="text-align: center">
						<button type="button" onclick="document.getElementById('page4').style.display = 'none'; document.getElementById('page3').style.display = 'block'">Back</button>
						<button type="button" onclick="document.getElementById('page4').style.display = 'none'; document.getElementById('page5').style.display = 'block'">Next</button>
					</td>
				</tr>
			</table>
			
			<table id=page5 style="display:none">
				<tr>
					<td colspan=2><b>Optional Parameters For Autopicking</b></td>
				</tr>
				<tr>
					<td>AutoPick</td>
					<td>
						<select data-required=no name=dopick>
							<option value=yes>Yes</option>
							<option value=no selected>No</option>
						</select>
					</td>
					<td>Deviation from Reference</td>
					<td><input data-required=no type=number name=nsig placeholder="quality of match between references and particles in standard deviations"></td>
				</tr>
				<tr>
					<td>Box Overlap Allowed</td>
					<td><input data-required=no type=number id=thres name=thres title="overlap between boxes, pixels"></td>
					<td>Particle Contrast</td>
					<td>
						<select data-required=no name=pcontrast>//
							<option value=black selected>Cryo</option>
							<option value=white >Negative Stain</option>
						</select>
					</td>
				</tr>
				<tr>
					<td>Picking References</td>
					<td><input data-required=no type=text name=refs id=refs></td>
					<td><img src=../img/folder.png onclick="fileSelect(this)" data-target=refs data-filter="pickrefs.mrc"></td>
				</tr>				
				<tr>
					<td colspan=5 style="text-align: center">
						<button type="button" onclick="document.getElementById('page5').style.display = 'none'; document.getElementById('page4').style.display = 'block'">Back</button>
						<button type="button" onclick="document.getElementById('page5').style.display = 'none'; document.getElementById('page6').style.display = 'block'">Next</button>
					</td>
				</tr>
			</table>
			
			<table id=page6 style="display:none">
				<tr>
					<td colspan=2><b>Run Parameters</b></td>
					<input type=hidden name=executable value=simple_distr_exec>
				</tr>
				<tr>
					<td>Number Parts</td>
					<td><input data-required=no type=number name=nparts placeholder="divide job into # parts" title="Number of parts to divide distributed job into for processing {1}"></td>
					<td>Number Threads per Part</td>
					<td><input data-required=no type=number name=nthr placeholder="# shared-memory CPU threads" title="Number of shared-memory CPU threads available {1}"></td>
				</tr>
					
				<tr>
					<td>Number of Compute Units</td>
					<td>
						<input type=number type=number name=ncunits placeholder="# independent computing units" title="Number of separate computing units available, should be >= number of parts {1}">
					</td>
					<td>Submit to Queue</td>
					<td>
						<select data-required=no name=queue_submit onchange="showHideQueueOptions()">
							<option value=yes>Yes</option>
							<option value=no selected>No</option>
						</select>
					</td>
				</tr>
					
				<tr data-queue=yes>
					<td>Maximum Job Time</td>
					<td>
						<input data-required=no type=number name=time_per_image placeholder="time allowed in queue per job (s)" title="Maximum time allowed in queue per job in seconds">
					</td>
				</tr>
				
				<tr data-queue=yes>
					<td>Memory Per Job</td>
					<td>
						<input data-required=no type=number name=job_memory_per_task placeholder="memory allocated per job (bytes)" title="Memory allocated per job in bytes" >
					</td>
					<td >Queue Partition</td>
					<td>
						<input data-required=no type=text name=qsys_partition placeholder="queue name" title="Name of queue to submit distributed jobs to">
					</td>
				</tr>
				
				<tr data-queue=yes>
					<td>Number Tasks Per Socket</td>
					<td>
						<input data-required=no type=number name=job_ntasks_per_socket placeholder="# jobs per CPU socket" title="Number of simultaneous jobs to run on each CPU socket">
					</td>
					<td >Job Identifier</td>
					<td>
						<input data-required=no type=text name=job_name placeholder="queue job name" title="Assign a job name to the submitted jobs">
					</td>
				</tr>
				
				<tr data-queue=yes>
					<td>Queue QOS</td>
					<td>
						<input data-required=no type=text name=qsys_qos>
					</td>
					<td >Submit Master to Queue</td>
					<td>
						<select data-required=no name=submitmaster title="Choose whether master process runs on queue or locally">
							<option value=yes>Yes</option>
							<option value=no selected>No</option>
						</select>
					</td>
				</tr>
				<tr>
					<td colspan=4 style="text-align: center">
						<button type="button" onclick="document.getElementById('page6').style.display = 'none'; document.getElementById('page5').style.display = 'block'">Back</button>
						<button type="button" onclick="document.getElementById('page6').style.display = 'none'; runJob(this)">Run</button>
					</td>
				</tr>
			</table>
			
		</form>
	</div>
	
	<div id=gauze class=gauze></div>

	<div class=selectfilepopup id=selectfilepopup>
	 <div class=header id=selectfileheader>
		<img class=simpleicon id=simpleicon src=../img/simple_favicon.ico>
		File Browser
		<img src=../img/close.png class=closeimage onclick='hideFileSelect()'>
	</div>
	 <div class=mainpane>
		 <input type=hidden id=filetarget>
		 <input type=hidden id=filefilter>
		<input class=selectfiledirectory id=selectfiledirectory>
		<div class=selectfiletable>
			<table id=selectfiletable></table>
		</div>
	</div>
	<button class=selectfilebutton onclick='hideFileSelect()'>Select</button>
   </div>
   
  <script src="../js/job.js"></script>
   <script>setReRun()</script>
  <script>setProjectTable()</script>
  <script>setProjectFolder()</script>
 </body>
</html>
