<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">

<!--Converted with LaTeX2HTML 2002-2-1 (1.71)
original version by:  Nikos Drakos, CBLU, University of Leeds
* revised and updated by:  Marcus Hennecke, Ross Moore, Herb Swan
* with significant contributions from:
  Jens Lippmann, Marek Rouchal, Martin Wilck and others -->
<HTML>
<HEAD>
<TITLE>2D alignment and clustering of the images</TITLE>
<META NAME="description" CONTENT="2D alignment and clustering of the images">
<META NAME="keywords" CONTENT="simple21manual">
<META NAME="resource-type" CONTENT="document">
<META NAME="distribution" CONTENT="global">

<META NAME="Generator" CONTENT="LaTeX2HTML v2002-2-1">
<META HTTP-EQUIV="Content-Style-Type" CONTENT="text/css">

<LINK REL="STYLESHEET" HREF="simple21manual.css">

<LINK REL="next" HREF="node23.html">
<LINK REL="previous" HREF="node21.html">
<LINK REL="up" HREF="node21.html">
<LINK REL="next" HREF="node23.html">
</HEAD>

<BODY >
<!--Navigation Panel-->
<A NAME="tex2html365"
  HREF="node23.html">
<IMG WIDTH="37" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="next"
 SRC="file:/sw/share/lib/latex2html/icons/next.png"></A> 
<A NAME="tex2html361"
  HREF="node21.html">
<IMG WIDTH="26" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="up"
 SRC="file:/sw/share/lib/latex2html/icons/up.png"></A> 
<A NAME="tex2html355"
  HREF="node21.html">
<IMG WIDTH="63" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="previous"
 SRC="file:/sw/share/lib/latex2html/icons/prev.png"></A> 
<A NAME="tex2html363"
  HREF="node1.html">
<IMG WIDTH="65" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="contents"
 SRC="file:/sw/share/lib/latex2html/icons/contents.png"></A>  
<BR>
<B> Next:</B> <A NAME="tex2html366"
  HREF="node23.html">Ab initio 3D reconstruction</A>
<B> Up:</B> <A NAME="tex2html362"
  HREF="node21.html">A comprehensive worked-out example</A>
<B> Previous:</B> <A NAME="tex2html356"
  HREF="node21.html">A comprehensive worked-out example</A>
 &nbsp; <B>  <A NAME="tex2html364"
  HREF="node1.html">Contents</A></B> 
<BR>
<BR>
<!--End of Navigation Panel-->

<H3><A NAME="SECTION00074100000000000000"></A>
<A NAME="2dclust"></A>
<BR>
2D alignment and clustering of the images
</H3>

<P>
Prior to 2D alignment and clustering, we begin by minimising the effect that off-centre particles could have on the subsequent steps. The method is not aimed at determining the rotational origin shifts exactly but only to roughly centre the particles in the box. This is done by bringing all particle images into broad register with respect to their 2D shifts only, regardless of their in-plane rotation. <FONT COLOR="#0f75ff"><TT>simple_stackops</TT></FONT> with the argument <TT>shalgn=yes</TT> is used, providing our stack (<TT>stk=particles.spi</TT>), sampling distance (<TT>smpd=1.62</TT>) and mask radius in pixels (<TT>msk=60</TT> as input
<PRE>
    $ simple_stackops stk=particles.spi smpd=1.62 msk=60 
    shalgn=yes trs=3.5 lp=20 nthr=8 outstk=particles_sh.spi
</PRE>
The shift alignment is done with a hard low-pass limit of 20 &#197; (<TT>lp=20</TT>), as are most of the following steps. The iterative process will typically take a dozen iterations (a few minutes). The <TT>trs</TT> argument limits the shift search to the <!-- MATH
 $[-trs,trs]$
 -->
<IMG
 WIDTH="81" HEIGHT="34" ALIGN="MIDDLE" BORDER="0"
 SRC="img6.png"
 ALT="$ [-trs,trs]$">
 range. We typically set the <TT>trs</TT> argument to 2.5% of the image dimension (140). There are 8 CPUs on our machine so we set the number of threads <TT>nthr=8</TT>. A new centred stack (named according to the <TT>outstk</TT> argument) will be written to disk and we will use this one for the reminder of the workflow. A document named <TT>shiftdoc.txt</TT> by default that contains the calculated shifts is also created.

<P>
Next we generate random class averages to initiate the 2D clustering procedure. Given the modest size of our dataset (10,000 images) we choose <TT>ncls=200</TT> to obtain sufficiently populated classes. We recommended increasing this number to at least 500 for larger datasets (&gt;30,000 images).
<PRE>
    $ simple_prime2D_init stk=particles_sh.spi smpd=1.62 msk=60 ncls=200 nthr=8
</PRE>
<FONT COLOR="#0f75ff"><TT>simple_prime2D_init</TT></FONT> will rapidly generate evenly populated class averages with random in-plane rotations. The stacks of 200 class averages are named <TT>startcavgsmsk.spi</TT> and <TT>startcavgs.spi</TT> (with and without mask). Next, we execute the 2D alignment and clustering in distributed mode
<PRE>
    $ simple_stackops stk=particles_sh.spi split=1
    $ nohup distr_simple.pl prg=prime2D stk=particles_sh.spi
    oritab=prime2D_startdoc.txt refs=startcavgsmsk.spi ncls=200
    srch_inpl=yes smpd=1.62 msk=60 lp=20 npart=1 &gt; PRIME2DOUT &amp;
</PRE>
The first instruction prepares the split stack for distributed execution. In our case we ran the clustering on a Linux workstation with 1 CPU chipset so we simply set <TT>split=1</TT>. If your machine has two chipsets, set split to 2 but keep in mind that the <TT>npart</TT> argument in the following instruction also needs to be set to 2. The second instruction starts the actual 2D clustering using the randomised classes as a starting point (<TT>refs</TT> argument). It will take approximately 15 iterations and little under 2 hours on a modern workstation with 8 CPUs. In the last lines of the log file <TT>PRIME2DOUT</TT> you should see something looking like
<PRE>
    &gt;&gt;&gt; DISTRIBUTION OVERLAP:                 0.9589
    &gt;&gt;&gt; PERCENTAGE OF SEARCH SPACE SCANNED:  99.6
    &gt;&gt;&gt; CORRELATION:                          0.7521
    &gt;&gt;&gt; CONVERGED: .YES.
</PRE>
Our criterion for convergence is based the stability of the clusters obtained. In other words, when the cluster assignments are nearly identical from one iteration to the next (distribution overlap  &gt;95% on average) and the particles cannot find a better matching average (fraction of search space scanned &gt;99%) the alignment and clustering stops. In addition, each run is structured as follows. Until near convergence (search space scanned &lt;90%) only cluster assignment and in-plane rotations are searched. After this, shifts are also searched and their limit is automatically set to 2.5% of the image dimension (see above). Every iteration produces a folder named <TT>prime2D_round_XX</TT> that contains all the information to continue a run: a document with the current in-plane parameters (<TT>prime2Ddoc_XX.txt</TT>) and two stacks of the current 200 class averages (masked and unmasked).

<P>
A number of temporary files are also created but they are only used internally and will be automatically deleted at the end of the run. As computer and network failures are part of using workstations and supercomputers you will be able to continue an interrupted run using the files present in these self-contained folders. You can also automatically remove the temporary files by simply typing: <FONT COLOR="#0f75ff"><TT>prime_cleanup.pl</TT></FONT>. Never do this while the application is running.  It is also necessary to keep the current folder organised to avoid data loss and confusion. We do not need the split stack anymore, so type
<PRE>
    $ rm stack_part*.spi
</PRE>
Visual examination of the 200 class averages (<TT>prime2D_round_15/cavgs_iter15.spi</TT>) shows numerous images with distinctive features of GroEL such as the double ring structure and the heptameric C-symmetric rings on a uniform grey background. One can also note blurrier images with less contrast. Typically, these correspond to lowly populated classes where the weaker SNR is likely to contribute little to the subsequent 3D reconstruction. Consequently, we rank the class averages by decreasing order of their population
<PRE>
    $ simple_rank_cavgs stk=prime2D_round_15/cavgs_iter15.spi 
    oritab=prime2D_round_15/prime2Ddoc_15.txt outstk=ranked_cavgs.spi
</PRE>
After visual inspection of the ranked class averages (we use EMAN for this (<A NAME="tex2html367"
  HREF="#Tang:2007aa">, </A>,)) we decide to discard the noisier/blurrier images by keeping the first 160 averages in the ranked stack. This discards clusters containing less than 30 images per class. We simply extract the top 160 averages using the command
<PRE>
    $ simple_stackops stk=ranked_cavgs.spi fromp=1 top=160 outstk=selected_cavgs.spi
</PRE>
where <TT>fromp</TT> and <TT>top</TT> define the range of images to keep. With this reduced stack (<TT>selected_cavgs.spi</TT>) we will generate an <I>ab initio</I> 3D reconstruction of the molecule using <FONT COLOR="#0f75ff"><TT>simple_prime3D</TT></FONT>
<P>
<HR>
<!--Navigation Panel-->
<A NAME="tex2html365"
  HREF="node23.html">
<IMG WIDTH="37" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="next"
 SRC="file:/sw/share/lib/latex2html/icons/next.png"></A> 
<A NAME="tex2html361"
  HREF="node21.html">
<IMG WIDTH="26" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="up"
 SRC="file:/sw/share/lib/latex2html/icons/up.png"></A> 
<A NAME="tex2html355"
  HREF="node21.html">
<IMG WIDTH="63" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="previous"
 SRC="file:/sw/share/lib/latex2html/icons/prev.png"></A> 
<A NAME="tex2html363"
  HREF="node1.html">
<IMG WIDTH="65" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="contents"
 SRC="file:/sw/share/lib/latex2html/icons/contents.png"></A>  
<BR>
<B> Next:</B> <A NAME="tex2html366"
  HREF="node23.html">Ab initio 3D reconstruction</A>
<B> Up:</B> <A NAME="tex2html362"
  HREF="node21.html">A comprehensive worked-out example</A>
<B> Previous:</B> <A NAME="tex2html356"
  HREF="node21.html">A comprehensive worked-out example</A>
 &nbsp; <B>  <A NAME="tex2html364"
  HREF="node1.html">Contents</A></B> 
<!--End of Navigation Panel-->
<ADDRESS>
Hans Elmlund
2016-05-24
</ADDRESS>
</BODY>
</HTML>
