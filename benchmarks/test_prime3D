#!/bin/bash
if [ -z "${SIMPLE_TESTBENCH_DATA+set}" ]; then
   echo "SIMPLE_TESTBENCH_DATA env variable is not set."; exit 1
fi

if [ ! -d "${SIMPLE_TESTBENCH_DATA}" ]; then
    echo "SIMPLE_TESTBENCH_DATA variable is not a directory."; exit 1
fi

if [ ! -d "${SIMPLE_TESTBENCH_DATA}/bgal" ]; then
    echo "recvol_1wcm is not a directory in the benchmark data folder."; exit 1
fi
SECONDS=0
cd ${SIMPLE_TESTBENCH_DATA}/bgal
#prime_cleanup.pl
#pkill simple_exec
 [ -d prime3D_bench ] && rm -rf prime3D_bench
# simple_exec prg=new_project projname=prime3D_bench
# if [ -d prime3D_bench ]; then
#     cd prime3D_bench
# simple_exec prg=import_cavgs   stk=../cavgs_final_ranked.mrc smpd=2.55 projfile=prime3D_bench.simple projname=prime3D_bench
# #simple_private_exec prg=import_particles ctf=yes pgrp=d2 deftab=../extract_params.txt oritab=../prime3Ddoc_035.txt  stk=../scaledsel.mrc smpd=2.55 projfile=prime3Dtest.simple nparts=2 mul=0.5 msk=40
# time  simple_distr_exec prg=refine3D stk=../scaledsel.mrc oritab=../prime3Ddoc_035.txt ctf=yes smpd=2.55 msk=40 pgrp=d2 deftab=../extract_params.txt eo=yes nparts=2 nthr=8 mul=0.5 > PRIME3D &
# fi
# simple_distr_exec prg=prime3D stk=scaledstack.mrc ctf=yes smpd=2.55 msk=40 pgrp=d2 deftab=../extract_params.txt eo=yes nparts=2 nthr=8 vol1=startvol_state01.mrc lp=15 PRIME3D
simple_exec prg=new_project projname=prime3D_bench

if [ ! -d prime3D_bench ];then
    echo ' simple_exec prg=new_project  FAILED!!!'
    exit 1
else
    cd prime3D_bench
    # simple_exec prg=import_particles ctf=yes  cs=2.7  fraca=0.1 kv=300 stk=../selected.mrc oritab=../prime3Ddoc_035.txt ctf=yes smpd=2.55 msk=40
    simple_exec prg=scale smpd=1.275 newbox=128 outstk=selected_dwnsc.mrc stk=../selected.mrc
    simple_exec prg=import_cavgs stk=selected_dwnsc.mrc  smpd=1.275
    #    time simple_distr_exec prg=cluster3D ncls=100 nparts=2 nthr=10

    time simple_distr_exec prg=initial_3Dmodel msk=44 pgrp=d2  nparts=2 nthr=10 eo=no > init3D.stdout 2>  init3D.stderr
    # Copy project files
    cp prime3D_bench.simple prime3D_bench.simple.bkup
    cp 1_initial_3Dmodel/prime3D_bench.simple ./
    #) > init3D.timing
    time simple_distr_exec prg=cluster3D msk=44 prgp=d2  nparts=2 nthr=10 lp=10 nstates=2 oritype=cls3D > cluster3D.stdout 2> cluster3D.stderr
    #) > cluster3D.timing
    # Assuming 42 iterations
    chimera 2_cluster3D/recvol_state01_iter042.mrc  2_cluster3D/recvol_state02_iter042.mrc
fi
duration=$SECONDS
echo "$(($duration / 60)) minutes and $(($duration % 60)) seconds elapsed."
