<DOCTYPE html>
<html>
	<head>
		<title>Simple</title>
		<style>
			body {
				font-family: Verdana, Geneva, sans-serif;
				margin: 0px;
				overflow: hidden;
			}
			.gauze{
				position: fixed;
				top: 0px;
				left: 0px;
				height: calc(100vh);
				width: calc(100vw);
				background-color: black;
				opacity: 0.4;
				display: none;
			}
		</style>
	</head>
	<body>
		<link rel=stylesheet href=header.css>
		<div include-html=header.html class=header></div>
		<link rel=stylesheet href=history.css>
		<div include-html=history.html class=history></div>
		<div id=gauze class=gauze></div>
		<link rel=stylesheet href=newproject.css>
		<div include-html=newproject.html class=newproject id=newproject></div>
		<link rel=stylesheet href=newjob.css>
		<div include-html=newjob.html class=newjob id=newjob></div>
		<link rel=stylesheet href=job.css>
		<div include-html=job.html class=job id=job></div>
		<link rel=stylesheet href=error.css>
		<div include-html=error.html class=error id=error></div>
		<link rel=stylesheet href=pipelineview.css>
		<div include-html=pipelineview.html class=pipelineview id=pipelineview></div>
		<link rel=stylesheet href=fileselector.css>
		<div include-html=fileselector.html class=fileselector id=fileselector></div>
		<link rel=stylesheet href=fileviewer.css>
		<div include-html=fileviewer.html class=fileviewer id=fileviewer></div>
	<script>
		includeHTML();
		
		var ws = new WebSocket('ws://' + location.host + '/ws/');
		ws.onopen = function(ev)  { console.log(ev); };
		ws.onerror = function(ev) { console.log(ev); };
		ws.onclose = function(ev) { console.log(ev); };
		ws.onmessage = function(ev) {
			websocketReceive(ev.data);
		}
		
		var pipelineviewarray = []; 
		var pipelineviewdata = [];
		var fileviewerdata = [];

		projectSelector();
		
		function getArgument(argumentstring, argumentname){
			var argumentarray = argumentstring.split(' ');
			var returnvalue = "";
			for (var i = 0; i < argumentarray.length; i++) {
				var keyvalue = argumentarray[i].split('=');
				if (keyvalue[0] == argumentname){
					returnvalue = keyvalue[1].replace(/\^/g, " ").replace(/\|/g, "=");
				}
			}
			return returnvalue;
		}
		
		function websocketSend(message){
			var sendinterval = setInterval(function(){ 
				if(ws.readyState === ws.CLOSED){
					ws = new WebSocket('ws://' + location.host + '/ws');
					ws.onopen = function(ev)  { console.log(ev); };
					ws.onerror = function(ev) { console.log(ev); };
					ws.onclose = function(ev) { console.log(ev); };
					ws.onmessage = function(ev) {
						websocketReceive(ev.data);
					}
				} else if (ws.readyState === ws.OPEN){
					ws.send(message);
					clearInterval(sendinterval);
				}
			}, 1000);
		}
		
		function websocketReceive(data){
			console.log(data);
			if(data instanceof Blob){
				
				var bloblength = data.size;
				var headerblob = data.slice(0, 560);
				var payloadblob = data.slice(560, bloblength);
			
				var reader = new FileReader();
				reader.onload = function(event){
					var header = reader.result;
					var callback = getArgument(header, "callback");
					window[callback](header, payloadblob);
				}
				reader.readAsText(headerblob);
			} else {
			
			var message = getArgument(data, "message");
			if(message != ""){
				//document.getElementById('gauze').style.display = "block";
				document.getElementById('error').style.display = "block";
				document.getElementById('errormessage').innerHTML = message;
				setTimeout(function(){  
					document.getElementById('error').style.display = "none";
					//document.getElementById('gauze').style.display = "none";
				}, 3000);
			}
			var callback = getArgument(data, "callback");
			if(callback != ""){
				window[callback](data);
			}
			
			}
		}
		
		function includeHTML() {
			var z, i, elmnt, file, xhttp;
			z = document.getElementsByTagName("*");
			for (i = 0; i < z.length; i++) {
				elmnt = z[i];
				file = elmnt.getAttribute("include-html");
				if (file) {
				  xhttp = new XMLHttpRequest();
				  xhttp.onreadystatechange = function() {
					if (this.readyState == 4 && this.status == 200) {
					  elmnt.innerHTML = this.responseText;
					  elmnt.removeAttribute("include-html");
					  includeHTML();
					}
				  }
				  xhttp.open("GET", file, true);
				  xhttp.send();
				  return;
				}
			}
		}
		
		function projectSelector(){
			var message = "cmd=sql sql=CREATE^TABLE^IF^NOT^EXISTS^PROJECTS(ID^INTEGER^PRIMARY^KEY^AUTOINCREMENT,^PROJECTNAME^TEXT^NOT^NULL,PROJECTFOLDER^TEXT^NOT^NULL,PROJECTTABLE^TEXT^NOT^NULL);";
			websocketSend(message);
			var message = "cmd=sql callback=projectSelectorCallback sql=SELECT^*^FROM^PROJECTS;";
			websocketSend(message);
		}
		
		function projectSelectorCallback(message){
			var projectselector = document.getElementById('projectselector');

			for(var i = projectselector.length; i > 1 ; i--){
				projectselector.remove(i);
			}
			var data = getArgument(message, "data");
			var dataarray = data.split(";");
			
			
			for(var i = 0; i < dataarray.length; i++){
				if (dataarray[i] != ""){
					var dataobject = JSON.parse(dataarray[i]);
					var option = document.createElement("option");
					option.text = dataobject.PROJECTNAME;
					option.value = dataobject.PROJECTFOLDER;
					option.id = dataobject.PROJECTTABLE;
					option.class = "project";
					projectselector.add(option);
				}
			}
		}
		
		function selectProject(){
			var projectselector = document.getElementById('projectselector');
			var project = projectselector.options[projectselector.selectedIndex].value;
			if (project == 'createnew'){
				document.getElementById('gauze').style.display = "block";
				document.getElementById('newproject').style.display = "block";
			} else {
				document.getElementById('historytable').innerHTML = "";
				document.getElementById('historyfolder').value = projectselector.options[projectselector.selectedIndex].value;
				document.getElementById('historytable').value = projectselector.options[projectselector.selectedIndex].id;
				refreshHistory();
				var message = "message=Changed^project^to^" + projectselector.options[projectselector.selectedIndex].innerHTML;
				websocketReceive(message)
			}
		}
		
		function addNewProject(){
			var randomnumber = Math.ceil(Math.random() *  100000);
			var sql = "INSERT INTO PROJECTS(PROJECTNAME, PROJECTFOLDER, PROJECTTABLE) VALUES ('" + document.getElementById('newprojectname').value + "','"  + document.getElementById('newprojectfolder').value + "','p" + randomnumber + "');";
			var message = "cmd=sql sql=" + sql.replace(/ /g, "^");
			websocketSend(message);
			var sql = "CREATE TABLE IF NOT EXISTS p" + randomnumber + " (ID INTEGER PRIMARY KEY AUTOINCREMENT, JOBNAME TEXT DEFAULT '', JOBFOLDER TEXT DEFAULT '', JOBSTATUS TEXT DEFAULT '', JOBTYPE TEXT DEFAULT '', JOBDESCRIPTION TEXT DEFAULT '', JOBARGUMENTS TEXT DEFAULT '', JOBPID TEXT DEFAULT '');";
			var message = "cmd=sql callback=addNewProjectCallback sql=" + sql.replace(/ /g, "^");
			websocketSend(message);
		}
		
		function addNewProjectCallback(message){
			projectSelector();
			var message = "message=Successfully^added^project";
			websocketReceive(message);
		}
		
		function refreshHistory(){
			document.getElementById('jobhistorytable').innerHTML = "";
			var sql = "SELECT * FROM " + document.getElementById('historytable').value + ";";
			var message = "cmd=sql callback=refreshHistoryCallback sql=" + sql.replace(/ /g, "^");
			websocketSend(message);
		}
		
		function refreshHistoryCallback(message){
			var data = getArgument(message, "data");
			var dataarray = data.split(";");
			var jobhistorytable = document.getElementById('jobhistorytable');
			
			for(var i = 0; i < dataarray.length; i++){
				if (dataarray[i] != ""){
					var dataobject = JSON.parse(dataarray[i]);
					var row = jobhistorytable.insertRow();
					var cell = row.insertCell();
					cell.innerHTML = dataobject.id;
					var cell = row.insertCell();
					cell.innerHTML = dataobject.JOBSTATUS.replace(/([+])/g, " ");
					var cell = row.insertCell();
					cell.innerHTML = dataobject.JOBTYPE.replace(/([+])/g, " ");
					var cell = row.insertCell();
					cell.innerHTML = dataobject.JOBNAME.replace(/([+])/g, " ");
					var cell = row.insertCell();
					cell.innerHTML = dataobject.JOBDESCRIPTION.replace(/([+])/g, " ");
					var cell = row.insertCell();
					var div = document.createElement("div");
					div.className = "historyactions";
					
					cell.appendChild(div);
					var img = document.createElement("img");
					img.setAttribute("src", "grid.png");
					div.appendChild(img);
					
					var div2 = document.createElement("div");
					div2.className = "hoverdiv";
					div.appendChild(div2);
					div2.id = dataobject.JOBFOLDER.replace(/([+])/g, " ");
					
					if (dataobject.JOBTYPE == "pipeline" || dataobject.JOBTYPE == "preproc" || dataobject.JOBTYPE == "unblur" || dataobject.JOBTYPE == "unblur_ctffind"){
						var div3 = document.createElement("div");
						div3.innerHTML = "Pipeline View";
						div3.onclick = function(){pipelineView(this)};
						div2.appendChild(div3);
					}
					
					var div4 = document.createElement("div");
					div4.id = dataobject.id;
					div4.innerHTML = "Delete Job";
					div4.onclick = function(){deleteJob(this)};
					div2.appendChild(div4);
					
					var div5 = document.createElement("div");
					div5.id = dataobject.id;
					div5.innerHTML = "View Files";
					div5.onclick = function(){document.getElementById("fileselectordirectory").value = this.parentElement.id; fileSelector("file", "fileviewerfile");};
					div2.appendChild(div5);
					
					if (dataobject.JOBSTATUS == "Running"){
						var div6 = document.createElement("div");
						div6.id = dataobject.id;
						div6.name = dataobject.JOBPID;
						div6.innerHTML = "Kill Job";
						div6.onclick = function(){killJob(this)};
						div2.appendChild(div6);
					}
					
					var div7 = document.createElement("div");
					div7.id = dataobject.id;
					div7.innerHTML = "View Log File";
					div7.onclick = function(){document.getElementById('fileviewerfile').value = this.parentElement.id + "/job.log"; fileViewer()};
					div2.appendChild(div7);
					
				}
			}
		}
			
		function selectWorkflow(element){
			var workflows = document.getElementsByClassName('newjobworkflow');
			for(var  i = 0; i < workflows.length; i++){
				workflows[i].style.backgroundColor = null;
			}
			element.style.backgroundColor = "orange";
			
			var jobs = document.getElementsByClassName('newjobjob');
			for(var  i = 0; i < jobs.length; i++){
				jobs[i].style.display = "none";
			}
			
			var jobs = document.getElementsByClassName(element.id);
			for(var  i = 0; i < jobs.length; i++){
				jobs[i].style.display = "block";
			}
		}
		
		function selectJob(element){
			var jobs = document.getElementsByClassName('newjobjob');
			for(var  i = 0; i < jobs.length; i++){
				jobs[i].style.backgroundColor = null;
			}
			
			element.style.backgroundColor = "orange";
			
			var job = document.getElementById(element.id + "job");
			jobWorkflowReset(job);
			var jobdescription = job.getElementsByClassName('jobdescription')[0].innerHTML;
			var newjobdescription = document.getElementById("newjobdescription");
			newjobdescription.innerHTML = jobdescription;
			
			var jobs = document.getElementsByClassName("jobbody");
			for(var i = 0; i < jobs.length; i++){
				jobs[i].style.display = "none";
			}
			
			job.style.display = "block";
			
		}
		
		function selectJobTab(element){
			var jobcontainer = element.parentElement.parentElement;
			var jobcolumns = jobcontainer.getElementsByClassName("jobcolumn");
			for(var i = 0; i < jobcolumns.length; i++){
				jobcolumns[i].style.display = "none";
			}
			jobcontainer.getElementsByClassName(element.id)[0].style.display = "inline-table";
		}
		
		function pipelineView(element){
			document.getElementById("pipelineviewpspeczoom").value = 3;
			document.getElementById("pipelineviewthumbzoom").value = 1;
			document.getElementById("pipelineviewpspecbrightness").value = 64;
			document.getElementById("pipelineviewthumbbrightness").value = 128;
			document.getElementById("pipelineviewpspeccontrast").value = 4;
			document.getElementById("pipelineviewthumbcontrast").value = 3;
			
			message = "cmd=pipelineview callback=pipelineViewCallback dir=" + element.parentElement.id;
			document.getElementById("pipelineviewdirectory").value = element.parentElement.id;
			websocketSend(message);
		}
		
		function pipelineViewCallback(message){
			document.getElementById("pipelineviewpage").value = 1;
			document.getElementById("gauze").style.display = "block";
			document.getElementById("pipelineview").style.display = "block";
			pipelineviewarray = [];
			var data = getArgument(message, "data");
			var selection = getArgument(message, "selected");
			var dataarray = data.split(";");
			
			
			
			for(var i = 0; i < dataarray.length; i++){
				if (dataarray[i] != ""){
					var pipelineviewarrayelement = []; // 0:intg 1:pspec 2:thumb 3:dfx 4:dfy 5:angast 6:selected
					var dataobject = JSON.parse(dataarray[i]);
					pipelineviewarrayelement.push(dataobject.intg);
					pipelineviewarrayelement.push(dataobject.pspec);
					pipelineviewarrayelement.push(dataobject.thumb);
					pipelineviewarrayelement.push(dataobject.dfx);
					pipelineviewarrayelement.push(dataobject.dfy);
					pipelineviewarrayelement.push(dataobject.angast);
					if(selection.includes(dataobject.intg)){
						pipelineviewarrayelement.push(1);
					} else {
						pipelineviewarrayelement.push(0);
					}
					pipelineviewarray.push(pipelineviewarrayelement);
				}
			}
			
			pipelineViewPage();
		}
			
		function pipelineViewPage(){
			var pipelineviewperpage = document.getElementById("pipelineviewperpage");
			document.getElementById("pipelineviewpagetotal").value = "/" + Math.ceil(pipelineviewarray.length / pipelineviewperpage.options[pipelineviewperpage.selectedIndex].value);
			var page = document.getElementById("pipelineviewpage").value;
			var pipelineviewperpage = document.getElementById("pipelineviewperpage");
			var perpage = pipelineviewperpage.options[pipelineviewperpage.selectedIndex].value;	
			
			var pspecbrightness = document.getElementById("pipelineviewpspecbrightness").value;
			var thumbbrightness = document.getElementById("pipelineviewthumbbrightness").value;
			var pspeccontrast = document.getElementById("pipelineviewpspeccontrast").value;
			var thumbcontrast = document.getElementById("pipelineviewthumbcontrast").value;
			
			var pipelineviewarea= document.getElementById("pipelineviewarea");
			pipelineviewarea.innerHTML = "";
			pipelineviewdata = [];
			
			for(var i = ((page - 1) * perpage); i < (page * perpage); i++){
				if (i < pipelineviewarray.length){
				var micrographdiv = document.createElement("div");
					micrographdiv.id = pipelineviewarray[i][0];
					micrographdiv.name = i;
					micrographdiv.className = "pipelineviewmicrograph";
					if(pipelineviewarray[i][6] == 1){
						micrographdiv.className = "pipelineviewmicrograph pipelineviewmicrographselected";
					}
					micrographdiv.onclick = function(){
						
						if (this.className == "pipelineviewmicrograph"){
							this.className = "pipelineviewmicrograph pipelineviewmicrographselected";
							pipelineviewarray[this.name][6] = 1;
						}else {
							this.className = "pipelineviewmicrograph";
							pipelineviewarray[this.name][6] = 0;
						}
					}
					
					var attributesdiv = document.createElement("div");
					attributesdiv.className = "pipelineviewattributes";
					var attributespre = document.createElement("pre");
					var filenamearray = pipelineviewarray[i][0].split("/");
					var filename = filenamearray[filenamearray.length -1];
					attributespre.innerHTML = filename + "\n";
					attributespre.innerHTML += "DFX\t" + pipelineviewarray[i][3] + "\n";
					attributespre.innerHTML += "DFY\t" + pipelineviewarray[i][4] + "\n";
					attributespre.innerHTML += "ANGAST\t" + pipelineviewarray[i][5] + "\n";
					attributesdiv.appendChild(attributespre);
					micrographdiv.appendChild(attributesdiv);
					
					var pspecdiv = document.createElement("div");
					pspecdiv.className = "pipelineviewimgdiv";
					var pspec = new Image();
					pspec.className = "pipelineviewpspec";
					pspec.id = pipelineviewarray[i][1];
					pspec.width = 200;
					pspec.height = 200;
					pspecdiv.appendChild(pspec);
					micrographdiv.appendChild(pspecdiv);
					
					var thumbdiv = document.createElement("div");
					thumbdiv.className = "pipelineviewimgdiv";
					var thumb = new Image();
					thumb.className = "pipelineviewthumb";
					thumb.id = pipelineviewarray[i][2]
					thumb.width = 200;
					thumb.height = 200;
					thumbdiv.appendChild(thumb);
					micrographdiv.appendChild(thumbdiv);
					
					pipelineviewarea.appendChild(micrographdiv);
					message = "cmd=getfile callback=pipelineViewPageCallback filename=" + pipelineviewarray[i][1] + " contrast=" + pspeccontrast + " brightness=" + pspecbrightness;
					websocketSend(message);
					message = "cmd=getfile callback=pipelineViewPageCallback filename=" + pipelineviewarray[i][2]+ " contrast=" + thumbcontrast + " brightness=" + thumbbrightness;
					websocketSend(message);
				}
			}
			
			var micrographs = document.getElementsByClassName("pipelineviewmicrograph");
		}
		
		function pipelineViewPageCallback(header, payload){
			var filename = getArgument(header, "filename");
			var image = document.getElementById(getArgument(header, "filename"));
			image.style.background = "url('" + URL.createObjectURL(payload) + "')";
			image.style.backgroundSize = "contain";
			if(filename.includes("pspec")){
				var pspeczoom = document.getElementById("pipelineviewpspeczoom").value;
				image.style.transform = "scale(" + pspeczoom + ")";
			}
			if(filename.includes("thumb")){
				var thumbzoom = document.getElementById("pipelineviewthumbzoom").value;
				image.style.transform = "scale(" + thumbzoom + ")"
			}
		}
		
		function pipelineViewSelectAll(){
			for(var i = 0; i < pipelineviewarray.length; i++){
				pipelineviewarray[i][6] = 1;
			}
			var pipelineviewarea = document.getElementById("pipelineviewarea");
			var pipelineviewmicrographs = pipelineviewarea.getElementsByClassName("pipelineviewmicrograph");
			for(var i = 0; i < pipelineviewmicrographs.length; i++){
				pipelineviewmicrographs[i].className = "pipelineviewmicrograph pipelineviewmicrographselected";
			}
		}
		
		function pipelineViewClearAll(){
			for(var i = 0; i < pipelineviewarray.length; i++){
				pipelineviewarray[i][6] = 0;
			}
			var pipelineviewarea = document.getElementById("pipelineviewarea");
			var pipelineviewmicrographs = pipelineviewarea.getElementsByClassName("pipelineviewmicrograph");
			for(var i = 0; i < pipelineviewmicrographs.length; i++){
				pipelineviewmicrographs[i].className = "pipelineviewmicrograph";
			}
		}
		
		function pipelineViewSortColumn(i){ 
			pipelineviewarray.sort(function(a,b) {
				return a[i]-b[i]
			});
		}
		
		function pipelineViewAutoSave(){
			
			var message = "cmd=pipelinesave callback=pipelineSaveCallback directory="+ document.getElementById("pipelineviewdirectory").value + " filename=.selection data=";
			for(var i = 0; i < pipelineviewarray.length; i++){
				if(pipelineviewarray[i][6] == 1){
					message += pipelineviewarray[i][0] + ";";
				}
			}
			websocketSend(message);
		}
		
		function pipelineViewSave(){
			var message = "cmd=pipelinesave callback=pipelineSaveCallback directory="+ document.getElementById("pipelineviewsavefolder").value + " filename=" + document.getElementById("pipelineviewsavefilename").value + " data=";
			
			for(var i = 0; i < pipelineviewarray.length; i++){
				if(pipelineviewarray[i][6] == 1){
					message += pipelineviewarray[i][0] + ";";
				}
			}
			console.log(message);
			websocketSend(message);
		}
		
		function newJob(element){
			var projectfolder = document.getElementById('historyfolder').value;
			var projecttable = document.getElementById('historytable').value;
			var jobargs = element.parentElement.getElementsByClassName('jobarg');
			var message = "projectfolder=" + projectfolder + " projecttable=" + projecttable + " callback=refreshHistory";
			for(var i = 0; i < jobargs.length; i++){
				message += " " + jobargs[i].id + "=" + jobargs[i].value.replace(/\s/g, '+');
			}
			websocketSend(message);
		}
		
		function fileSelector(type, caller){
			document.getElementById('fileselectorcaller').value = caller;
			
			if(type == "folder"){
				document.getElementById('fileselectorheader').innerHTML = "Select Folder";
				document.getElementById('fileselectordirectory').onkeydown = function(event){
					if (event.keyCode == 13){
						document.getElementById('fileselectortable').innerHTML = "";
						var message = "cmd=fileselector callback=fileSelectorFolderCallback directory="+ document.getElementById("fileselectordirectory").value;
						websocketSend(message);
					}
				}
				document.getElementById('fileselectorback').onclick = function(){
					document.getElementById('fileselectortable').innerHTML = "";
					var directoryarray = document.getElementById("fileselectordirectory").value.split('/');
					var newdirectory = "/";
					for(var i = 1; i < directoryarray.length - 1; i++){
						newdirectory += directoryarray[i];
						if(i < directoryarray.length - 2){
							newdirectory += "/";
						}
					}
					document.getElementById("fileselectordirectory").value = newdirectory;
					var message = "cmd=fileselector callback=fileSelectorFolderCallback directory="+ document.getElementById("fileselectordirectory").value;
					websocketSend(message);
				}
				
			} else if(type == "file"){
				document.getElementById('fileselectorheader').innerHTML = "Select File";
				document.getElementById('fileselectordirectory').onkeydown = function(event){
					if (event.keyCode == 13){
						document.getElementById('fileselectortable').innerHTML = "";
						var message = "cmd=fileselector callback=fileSelectorFileCallback directory="+ document.getElementById("fileselectordirectory").value;
						websocketSend(message);
					}
				}
				document.getElementById('fileselectorback').onclick = function(){
					document.getElementById('fileselectortable').innerHTML = "";
					var directoryarray = document.getElementById("fileselectordirectory").value.split('/');
					var newdirectory = "/";
					for(var i = 1; i < directoryarray.length - 1; i++){
						newdirectory += directoryarray[i];
						if(i < directoryarray.length - 2){
							newdirectory += "/";
						}
					}
					document.getElementById("fileselectordirectory").value = newdirectory;
					var message = "cmd=fileselector callback=fileSelectorFileCallback directory="+ document.getElementById("fileselectordirectory").value;
					websocketSend(message);
				}
			}
			document.getElementById('fileselectortable').innerHTML = "";
			document.getElementById('gauze').style.display = "block";
			document.getElementById('fileselector').style.display = "block";
			if(type == "folder"){
				var message = "cmd=fileselector callback=fileSelectorFolderCallback directory="+ document.getElementById("fileselectordirectory").value;
			} else if(type == "file"){
				var message = "cmd=fileselector callback=fileSelectorFileCallback directory="+ document.getElementById("fileselectordirectory").value;
			}
			websocketSend(message);
		}
		
		function fileSelectorFileCallback(message){
			var directory = getArgument(message, "directory");
			document.getElementById('fileselectordirectory').value = directory;
			
			var fileselectortable = document.getElementById('fileselectortable');
			var directories = getArgument(message, "directories");
			var directoriesarray = directories.split(";");
			for(var i = 0; i < directoriesarray.length; i++){
				if (directoriesarray[i] != ""){
					var row = fileselectortable.insertRow();
					var cell = row.insertCell();
					var directoryarray = directoriesarray[i].split("/");
					cell.innerHTML = "<img src=folder.png class=fileselectorfolderimage>";
					cell.innerHTML += directoryarray[directoryarray.length - 1];
					cell.id = directoriesarray[i];
					cell.ondblclick = function(){
						document.getElementById('fileselectortable').innerHTML = "";
						document.getElementById("fileselectordirectory").value = this.id;
						var message = "cmd=fileselector callback=fileSelectorFileCallback directory="+ document.getElementById("fileselectordirectory").value;
						websocketSend(message);
					}
					cell.onclick = function(){
						var selected = document.getElementsByClassName('fileselectorselected');
						for(var j = 0; j < selected.length; j++){
							selected[j].className = "";
						}
						this.className = "fileselectorselected";
						var caller = document.getElementById('fileselectorcaller').value;
						document.getElementById(caller).value = this.id;
					}
				}
			}
			var files = getArgument(message, "files");
			var filesarray = files.split(";");
			for(var i = 0; i < filesarray.length; i++){
				if (filesarray[i] != ""){
					var row = fileselectortable.insertRow();
					var cell = row.insertCell();
					var filearray = filesarray[i].split("/");
					cell.innerHTML = filearray[filearray.length - 1];
					cell.id = filesarray[i];
					cell.onclick = function(){
						var selected = document.getElementsByClassName('fileselectorselected');
						for(var j = 0; j < selected.length; j++){
							selected[j].className = "";
						}
						this.className = "fileselectorselected";
						var caller = document.getElementById('fileselectorcaller').value;
						document.getElementById(caller).value = this.id;
					}
				}
			}
		}
	
		function fileSelectorFolderCallback(message){
			var directory = getArgument(message, "directory");
			document.getElementById('fileselectordirectory').value = directory;
			
			var fileselectortable = document.getElementById('fileselectortable');
			var directories = getArgument(message, "directories");
			var directoriesarray = directories.split(";");
			for(var i = 0; i < directoriesarray.length; i++){
				if (directoriesarray[i] != ""){
					var row = fileselectortable.insertRow();
					var cell = row.insertCell();
					cell.id = directoriesarray[i];
					var directoryarray = directoriesarray[i].split("/");
					cell.innerHTML = "<img src=folder.png class=fileselectorfolderimage>";
					cell.ondblclick = function(){
						document.getElementById("fileselectordirectory").value = this.id;
						document.getElementById('fileselectortable').innerHTML = "";
						var message = "cmd=fileselector callback=fileSelectorFolderCallback directory="+ document.getElementById("fileselectordirectory").value;
						websocketSend(message);
					}
				//	var cell = row.insertCell();
				//	cell.id = directoriesarray[i];
					cell.innerHTML += directoryarray[directoryarray.length - 1];
					cell.onclick = function(){
						var selected = document.getElementsByClassName('fileselectorselected');
						for(var j = 0; j < selected.length; j++){
							selected[j].className = "";
						}
						this.className = "fileselectorselected";
						var caller = document.getElementById('fileselectorcaller').value;
						document.getElementById(caller).value = this.id;
					}
				}
			}
		}
		
		function fileViewer(){
			document.getElementById('fileviewerarea').innerHTML = "";
			document.getElementsByClassName('fileviewercontrast').value = 1;
			document.getElementsByClassName('fileviewerbrightness').value = 128;
			document.getElementsByClassName('fileviewerzoom').value = 1;
			document.getElementsByClassName('fileviewersize').value = 1;
			document.getElementById('fileviewer').style.display = "block";
			var fileviewerfile = document.getElementById('fileviewerfile').value;
			var message = "cmd=getfile callback=fileViewerCallback filename=" + fileviewerfile + " contrast=1 brightness=128";
			websocketSend(message);
		}
		
		function fileViewerCallback(header, payload){
			console.log("view");
			var fileviewerarea = document.getElementById('fileviewerarea');
			if(payload instanceof Blob){
				var nx = getArgument(header, "nx");
				var ny = getArgument(header, "ny");
				var nz = getArgument(header, "nz");
				
				var size = document.getElementById('fileviewersize').value;
				for (var i = 0; i < nz; i++){
					var image = new Image();
					image.style.background = "url('" + URL.createObjectURL(payload) + "') 0 -" + (ny * i * size) + "px";
					image.style.backgroundSize = nx * size + "px";
					image.style.width = nx * size;
					image.style.height = ny * size;
					
					image.className = "mrcframe";
					image.addEventListener('click', function(event){
						if(this.className == "mrcframe"){
							this.className = "mrcframe mrcframeselected";
						}else{
							this.className = "mrcframe";
						}
					}, false);
					fileviewerarea.appendChild(image);
				}
			}
			else{
				var pre = document.createElement("PRE");
				var data = header.split("text=");
				pre.innerHTML = data[1];
				fileviewerarea.appendChild(pre);
			}
		}		
			
		function fileViewerUpdate(){
			var contrast = document.getElementById('fileviewercontrast').value;
			var brightness = document.getElementById('fileviewerbrightness').value;
			
			var fileviewerarea = document.getElementById('fileviewerarea');
			var fileviewerfile = document.getElementById('fileviewerfile').value;
			
			fileviewerarea.innerHTML = "";
			message = "cmd=getfile callback=fileViewerCallback filename=" + fileviewerfile + " contrast=" + contrast + " brightness=" + brightness;
			websocketSend(message);
		}
				
		function fileviewerSave(){
			var message = "cmd=savestack stackfile="+ document.getElementById("fileviewerfile").value + " directory="+ document.getElementById("fileviewersavefolder").value + " filename=" + document.getElementById("fileviewersavefilename").value + " data=";
			var selection = document.getElementsByClassName('mrcframeselected');
			for(var i = 0; i < selection.length; i++){
				message += selection[i].id + ";";
			}
			
			console.log(message);
			websocketSend(message);
		}
		
		function deleteJob(element){
			var jobdir = element.parentElement.id;
			var jobid = element.id;
			var historytable = document.getElementById('historytable').value;
			var sql = "DELETE FROM " + historytable + " WHERE id=" +jobid;
			var message = "cmd=deletejob callback=refreshHistory sql=" + sql.replace(/ /g, "^") + " removedir=" + element.parentElement.id;
			websocketSend(message);
			console.log(message);
		}
		
		function killJob(element){
			var jobid = element.id;
			var historytable = document.getElementById('historytable').value;
			var sql = "UPDATE " + historytable + " SET JOBSTATUS='Killed' WHERE id=" + jobid + ";";
			var message = "cmd=killjob callback=refreshHistory sql=" + sql.replace(/ /g, "^") + "pid=" + element.name;
			websocketSend(message);
			console.log(message);
		}
		
		function jobWorkflowReset(element){
			console.log(element.id);
			var workflowelements = element.getElementsByClassName('jobworkflowheader');
			var workflowpages = element.getElementsByClassName('jobworkflowpage');
			element.getElementsByClassName('jobworkflow')[0].id = 0;
			for(var i = 0; i < workflowelements.length; i++){
				workflowelements[i].style.background =  "#7891b0";
				workflowpages[i].style.display =  "none";
			}
			workflowelements[0].style.background =  "orange";
			workflowpages[0].style.display =  "block";
			element.getElementsByClassName('newjobbutton')[1].innerHTML = "Next";
			element.getElementsByClassName('newjobbutton')[0].style.display = "none"
		}
		
		function jobWorkflowNext(element){
			var parent = element.parentNode.parentNode;
			var id = parent.getElementsByClassName('jobworkflow')[0].id;
			var workflowelements = parent.getElementsByClassName('jobworkflowheader');
			var workflowpages = parent.getElementsByClassName('jobworkflowpage');
			var jobargsrequired = workflowpages[id].getElementsByClassName('jobargrequired');
			
			for(var i = 0; i < jobargsrequired.length; i++){
				if(jobargsrequired[i].value == ""){
						jobargsrequired[i].style.border = "solid red";
					return;
				}
				jobargsrequired[i].style.border = "none";
			}
			
			if(id == (workflowelements.length - 1)){
				document.getElementById("job").style.display = "none"; 
				document.getElementById("gauze").style.display = "none";
				newJob(element.parentNode);
				return;
			}
			
			workflowelements[id].style.background = "#7891b0";
			workflowpages[id].style.display =  "none";

			id++;
			parent.getElementsByClassName('jobworkflow')[0].id = id;
			workflowelements[id].style.background = "orange";
			workflowpages[id].style.display =  "block";
			if(id == (workflowelements.length - 1)){
				element.innerHTML = "Run";
			}
			parent.getElementsByClassName('newjobbutton')[0].style.display = "inline-block"
		}
		
		function jobWorkflowBack(element){
			var parent = element.parentNode.parentNode;
			var id = parent.getElementsByClassName('jobworkflow')[0].id;
			var workflowelements = parent.getElementsByClassName('jobworkflowheader');
			var workflowpages = parent.getElementsByClassName('jobworkflowpage');
			workflowelements[id].style.background = "#7891b0";
			workflowpages[id].style.display =  "none";
			id--;
			parent.getElementsByClassName('jobworkflow')[0].id = id;
			workflowelements[id].style.background = "orange";
			workflowpages[id].style.display =  "block";
			if(id != (workflowelements.length - 1)){
				parent.getElementsByClassName('newjobbutton')[1].innerHTML = "Next"
			}
			if(id == 0){
				element.style.display = "none";
			}
		}
		
			
	</script>
	</body>
</html> 
